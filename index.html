<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hệ thống Quản lý Địa bàn & Hộ dân</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}</style>
  <meta name="theme-color" content="#4f46e5" />
  <link rel="manifest" href="/manifest.json">
</head>
<body class="bg-slate-50 min-h-screen p-6">
  <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-md overflow-hidden">
    <header class="flex items-center justify-between p-6 border-b">
      <div>
        <h1 class="text-2xl font-bold">Hệ thống Quản lý Địa bàn & Hộ dân</h1>
        <p class="text-sm text-slate-500">Quản lý thôn/buôn — hộ — thành viên — tổ ANTT</p>
      </div>
      <div class="flex items-center gap-3">
        <div id="auth-area" class="flex items-center gap-3">
          <button id="btn-signin" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Đăng nhập</button>
          <button id="btn-signout" class="px-4 py-2 border rounded-md hidden">Đăng xuất</button>
        </div>
        <button id="btn-import" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Nhập Excel / Docx</button>
        <input id="file-xlsx" type="file" accept=".xlsx,.xls,.csv,.docx" class="hidden">
        <button id="btn-sync" class="px-4 py-2 border rounded-md bg-white hover:bg-slate-50">Đồng bộ với Supabase</button>
      </div>
    </header>

    <main class="p-6">
      <!-- Tabs -->
      <div class="mb-6">
        <nav class="flex gap-2">
          <button data-tab="precincts" class="tab-btn active px-4 py-2 rounded-md bg-indigo-50 text-indigo-700 font-medium">Thôn/Buôn</button>
          <button data-tab="households" class="tab-btn px-4 py-2 rounded-md hover:bg-slate-100">Hộ gia đình</button>
          <button data-tab="security" class="tab-btn px-4 py-2 rounded-md hover:bg-slate-100">Tổ ANTT</button>
          <button data-tab="reports" class="tab-btn px-4 py-2 rounded-md hover:bg-slate-100">Báo cáo</button>
          <button data-tab="settings" class="tab-btn px-4 py-2 rounded-md hover:bg-slate-100">Cấu hình</button>
        </nav>
      </div>

      <!-- Tab contents -->
      <section id="precincts" class="tab-content">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Danh sách Thôn/Buôn</h2>
          <div class="flex gap-2">
            <input id="search-precinct" placeholder="Tìm thôn/buôn..." class="px-3 py-2 border rounded-md" />
            <button id="add-precinct" class="px-3 py-2 bg-green-600 text-white rounded-md">+ Thêm</button>
          </div>
        </div>
        <div id="precincts-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
      </section>

      <section id="households" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Danh sách Hộ</h2>
          <div class="flex gap-2">
            <input id="search-household" placeholder="Tìm theo tên, CCCD, thôn..." class="px-3 py-2 border rounded-md w-80" />
            <button id="add-household" class="px-3 py-2 bg-green-600 text-white rounded-md">+ Thêm Hộ</button>
          </div>
        </div>
        <div id="households-table" class="overflow-auto border rounded-md bg-white">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-left">
              <tr>
                <th class="p-2">#</th>
                <th class="p-2">Chủ hộ</th>
                <th class="p-2">CCCD</th>
                <th class="p-2">Thôn/Buôn</th>
                <th class="p-2">Số người</th>
                <th class="p-2">Hành động</th>
              </tr>
            </thead>
            <tbody id="households-tbody"></tbody>
          </table>
        </div>
      </section>

      <section id="security" class="tab-content hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Danh sách Tổ ANTT</h2>
          <div>
            <button id="import-security" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Import từ Quyết định (docx/xlsx)</button>
          </div>
        </div>
        <div id="security-table" class="overflow-auto border rounded-md bg-white">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100 text-left">
              <tr>
                <th class="p-2">#</th>
                <th class="p-2">Thôn/Buôn</th>
                <th class="p-2">Họ tên</th>
                <th class="p-2">Số CCCD</th>
                <th class="p-2">Chức danh</th>
                <th class="p-2">SĐT</th>
              </tr>
            </thead>
            <tbody id="security-tbody"></tbody>
          </table>
        </div>
      </section>

      <section id="reports" class="tab-content hidden">
        <h2 class="text-lg font-semibold mb-4">Báo cáo & Thống kê</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="p-4 bg-white border rounded-md">
            <div class="text-sm text-slate-500">Số hộ</div>
            <div id="stat-households" class="text-2xl font-bold">0</div>
          </div>
          <div class="p-4 bg-white border rounded-md">
            <div class="text-sm text-slate-500">Tổng nhân khẩu</div>
            <div id="stat-population" class="text-2xl font-bold">0</div>
          </div>
          <div class="p-4 bg-white border rounded-md">
            <div class="text-sm text-slate-500">Số thành viên Tổ ANTT</div>
            <div id="stat-security" class="text-2xl font-bold">0</div>
          </div>
        </div>
        <canvas id="chart-pop" class="bg-white border rounded-md p-2"></canvas>
      </section>

      <section id="settings" class="tab-content hidden">
        <h2 class="text-lg font-semibold mb-4">Cấu hình</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="p-4 bg-white border rounded-md">
            <label class="block text-sm text-slate-600">Supabase URL</label>
            <input id="cfg-url" class="mt-2 px-3 py-2 border rounded-md w-full" placeholder="https://xyz.supabase.co" />
            <label class="block text-sm text-slate-600 mt-3">Supabase anon key</label>
            <input id="cfg-key" class="mt-2 px-3 py-2 border rounded-md w-full" placeholder="anon key" />
            <div class="mt-3 flex gap-2">
              <button id="save-cfg" class="px-3 py-2 bg-indigo-600 text-white rounded-md">Lưu cấu hình</button>
              <button id="test-conn" class="px-3 py-2 border rounded-md">Kiểm tra kết nối</button>
            </div>
            <p class="text-xs text-slate-400 mt-2">Ghi chú: tạo các bảng `precincts`, `households`, `security_team` trong Supabase trước khi đồng bộ (thêm unique key trên `cccd` nếu muốn upsert an toàn).</p>
          </div>
          <div class="p-4 bg-white border rounded-md">
            <h3 class="font-semibold mb-2">PWA & Service Worker</h3>
            <p class="text-sm text-slate-600">Ứng dụng có thể cài làm PWA trên điện thoại. Service worker sẽ cache shell cơ bản.</p>
            <button id="install-pwa" class="mt-3 px-3 py-2 bg-green-600 text-white rounded-md">Hướng dẫn cài PWA</button>
          </div>
        </div>
      </section>

    </main>

    <footer class="p-4 text-sm text-slate-500 border-t">Powered by Supabase • Thiết kế cho quản lý địa bàn</footer>
  </div>

  <!-- Modal (simple) -->
  <div id="modal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-md p-6 w-full max-w-2xl">
      <h3 id="modal-title" class="text-lg font-semibold mb-4">Form</h3>
      <div id="modal-body"></div>
      <div class="mt-4 flex justify-end gap-2">
        <button id="modal-cancel" class="px-4 py-2 border rounded-md">Hủy</button>
        <button id="modal-save" class="px-4 py-2 bg-indigo-600 text-white rounded-md">Lưu</button>
      </div>
    </div>
  </div>

  <!-- Libraries: Supabase ESM, SheetJS, Chart.js, Mammoth for .docx -->
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'
    // Chart.js ESM
    import Chart from 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.esm.min.js'

    // App state
    let supabase = null;
    let CONFIG = { SUPABASE_URL: '', SUPABASE_ANON_KEY: '' };
    let state = { precincts: [], households: [], security: [] };

    // DOM refs
    const tabs = document.querySelectorAll('.tab-btn');
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalSave = document.getElementById('modal-save');
    const modalCancel = document.getElementById('modal-cancel');

    function showModal(title, html, onSave){ modalTitle.textContent = title; modalBody.innerHTML = html; modal.classList.remove('hidden'); modalSave.onclick = ()=>{ onSave(); modal.classList.add('hidden'); }; }
    modalCancel.onclick = ()=> modal.classList.add('hidden');

    tabs.forEach(b=>b.addEventListener('click', ()=>{ tabs.forEach(x=>x.classList.remove('active','bg-indigo-50','text-indigo-700')); b.classList.add('active','bg-indigo-50','text-indigo-700'); document.querySelectorAll('.tab-content').forEach(s=>s.classList.add('hidden')); document.getElementById(b.dataset.tab).classList.remove('hidden'); }));

    // Render helpers (same as before with minor improvements)
    function renderPrecincts(){ const el = document.getElementById('precincts-list'); el.innerHTML = ''; state.precincts.forEach((p,idx)=>{ const card = document.createElement('div'); card.className = 'p-4 border rounded-md bg-white'; card.innerHTML = `<div class="flex justify-between items-start"><div><div class="font-semibold">${p.name}</div><div class="text-sm text-slate-500">ID: ${p.id || idx+1}</div></div><div class="flex gap-2"><button data-id="${p.id || idx}" class="open-household px-3 py-1 border rounded-md text-sm">Xem hộ</button><button data-id="${p.id || idx}" class="edit-precinct px-3 py-1 border rounded-md text-sm">Sửa</button></div></div>`; el.appendChild(card); }); document.querySelectorAll('.open-household').forEach(btn=>btn.addEventListener('click', (ev)=>{ const id = ev.target.dataset.id; showHouseholdsForPrecinct(id); document.querySelector('[data-tab="households"]').click(); })); }
    function renderHouseholds(){ const tbody = document.getElementById('households-tbody'); tbody.innerHTML = ''; state.households.forEach((h, i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2 align-top">${i+1}</td><td class="p-2 align-top">${h.name}</td><td class="p-2 align-top">${h.cccd || ''}</td><td class="p-2 align-top">${h.precinct || ''}</td><td class="p-2 align-top">${h.count || ''}</td><td class="p-2 align-top"><button data-i="${i}" class="edit-household px-2 py-1 border rounded-md text-sm">Sửa</button> <button data-i="${i}" class="del-household px-2 py-1 border rounded-md text-sm">Xóa</button></td>`; tbody.appendChild(tr); }); document.querySelectorAll('.edit-household').forEach(btn=>btn.addEventListener('click',(e)=>{ const idx = e.target.dataset.i; editHouseholdForm(idx); })); document.querySelectorAll('.del-household').forEach(btn=>btn.addEventListener('click',(e)=>{ const idx = e.target.dataset.i; if(confirm('Xóa hộ này?')){ state.households.splice(idx,1); renderHouseholds(); updateStats(); } })); }
    function renderSecurity(){ const tbody = document.getElementById('security-tbody'); tbody.innerHTML = ''; state.security.forEach((s,i)=>{ const tr = document.createElement('tr'); tr.innerHTML = `<td class="p-2">${i+1}</td><td class="p-2">${s.precinct || ''}</td><td class="p-2">${s.name}</td><td class="p-2">${s.cccd || ''}</td><td class="p-2">${s.role || ''}</td><td class="p-2">${s.phone || ''}</td>`; tbody.appendChild(tr); }); }
    function updateStats(){ document.getElementById('stat-households').textContent = state.households.length; const pop = state.households.reduce((s,h)=>s+Number(h.count||0),0); document.getElementById('stat-population').textContent = pop; document.getElementById('stat-security').textContent = state.security.length; renderChart(); }

    function editHouseholdForm(idx){ const h = state.households[idx]; showModal('Sửa Hộ', `<div class="grid gap-2"><label>Chủ hộ</label><input id="f-house-name" value="${h.name}" class="px-3 py-2 border rounded-md" /><label>Số CCCD</label><input id="f-house-cccd" value="${h.cccd||''}" class="px-3 py-2 border rounded-md" /><label>Thôn/Buôn</label><input id="f-house-precinct" value="${h.precinct||''}" class="px-3 py-2 border rounded-md" /><label>Số người</label><input id="f-house-count" type="number" value="${h.count||0}" class="px-3 py-2 border rounded-md" /></div>`, ()=>{ h.name = document.getElementById('f-house-name').value.trim(); h.cccd = document.getElementById('f-house-cccd').value.trim(); h.precinct = document.getElementById('f-house-precinct').value.trim(); h.count = Number(document.getElementById('f-house-count').value||0); renderHouseholds(); updateStats(); }); }

    // Add forms
    document.getElementById('add-precinct').addEventListener('click', ()=>{ showModal('Thêm Thôn/Buôn', `<div class="grid gap-2"><label>Tên</label><input id="f-precinct-name" class="px-3 py-2 border rounded-md" /></div>`, ()=>{ const name = document.getElementById('f-precinct-name').value.trim(); if(!name) return alert('Nhập tên'); state.precincts.push({id:Date.now(), name}); renderPrecincts(); }); });
    document.getElementById('add-household').addEventListener('click', ()=>{ showModal('Thêm Hộ', `<div class="grid gap-2"><label>Chủ hộ</label><input id="f-house-name" class="px-3 py-2 border rounded-md" /><label>Số CCCD</label><input id="f-house-cccd" class="px-3 py-2 border rounded-md" /><label>Thôn/Buôn</label><input id="f-house-precinct" class="px-3 py-2 border rounded-md" /><label>Số người</label><input id="f-house-count" type="number" class="px-3 py-2 border rounded-md" /></div>`, ()=>{ const h = { name: document.getElementById('f-house-name').value.trim(), cccd: document.getElementById('f-house-cccd').value.trim(), precinct: document.getElementById('f-house-precinct').value.trim(), count: Number(document.getElementById('f-house-count').value||0) }; if(!h.name) return alert('Nhập tên chủ hộ'); state.households.push(h); renderHouseholds(); updateStats(); }); });

    // File import (SheetJS + mammoth for docx)
    const fileInput = document.getElementById('file-xlsx');
    document.getElementById('btn-import').addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const name = f.name || '';
      if(name.endsWith('.docx')){
        // Use mammoth to extract text and try to parse table-like content
        const arrayBuffer = await f.arrayBuffer();
        // dynamic import mammoth from CDN
        const mammoth = await import('https://unpkg.com/mammoth/mammoth.browser.min.js');
        const result = await mammoth.convertToHtml({arrayBuffer});
        // Basic heuristic: extract rows from HTML tables
        const div = document.createElement('div'); div.innerHTML = result.value;
        const tables = div.querySelectorAll('table');
        if(tables.length===0) return alert('Không tìm thấy bảng trong file .docx');
        // We'll try to parse first table as security team if headers match
        const rows = Array.from(tables[0].querySelectorAll('tr')).map(tr=>Array.from(tr.children).map(td=>td.textContent.trim()));
        // Heuristic mapping: find columns like Thôn/Buôn, Họ và tên, Số CCCD, Chức Danh, SĐT
        const header = rows[0].map(h=>h.toLowerCase());
        const colIdx = (colNames)=>{ for(const name of colNames){ const idx = header.findIndex(h=>h.includes(name)); if(idx>=0) return idx; } return -1 };
        const idxPrec = colIdx(['thôn','buôn','thôn,','thôn/buôn']);
        const idxName = colIdx(['họ','tên','họ và tên']);
        const idxCccd = colIdx(['cccd','số cccd','số căn']);
        const idxRole = colIdx(['chức','chức danh']);
        const idxPhone = colIdx(['sđt','điện thoại']);
        for(let i=1;i<rows.length;i++){ const r = rows[i]; state.security.push({ precinct: r[idxPrec]||'', name: r[idxName]||'', cccd: r[idxCccd]||'', role: r[idxRole]||'', phone: r[idxPhone]||'' }); }
        renderSecurity(); updateStats(); alert('Đã import Quyết định (một bảng). Kiểm tra danh sách Tổ ANTT.');
        return;
      }
      // For Excel/CSV
      const data = await f.arrayBuffer();
      const XLSX = await import('https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js');
      const wb = XLSX.read(data);
      if(wb.SheetNames.includes('Households')){
        const ws = wb.Sheets['Households'];
        const json = XLSX.utils.sheet_to_json(ws, {defval: ''});
        json.forEach(r=>{ state.households.push({ name: r['Họ tên chủ hộ'] || r['Tên Chủ Hộ'] || r['Tên Chủ Hộ'] || r['Tên'] || r['name'] || r['Họ và tên'] , cccd: r['Số CCCD'] || r['Số căn cước'] || r['CCCD'], precinct: r['Thôn/Buôn'] || r['Thôn'] || r['precinct'], count: Number(r['Số người']||r['Số Người']||r['Số người trong hộ']||0) }); });
      }
      if(wb.SheetNames.includes('Precincts')){
        const ws = wb.Sheets['Precincts'];
        const json = XLSX.utils.sheet_to_json(ws, {defval: ''});
        json.forEach(r=> state.precincts.push({ id: r['ID']||Date.now()+Math.random(), name: r['Tên Thôn/Buôn']||r['Tên']||r['name'] }));
      }
      if(wb.SheetNames.includes('Security_Team')||wb.SheetNames.includes('Security')){
        const ws = wb.Sheets[wb.SheetNames.includes('Security_Team')? 'Security_Team' : 'Security'];
        const json = XLSX.utils.sheet_to_json(ws, {defval: ''});
        json.forEach(r=> state.security.push({ precinct: r['Thôn/Buôn']||r['Thôn']||r['precinct'], name: r['Họ Tên']||r['Họ và tên']||r['name'], cccd: r['Số CCCD']||r['CCCD'], role: r['Chức Danh']||r['Chức danh']||r['role'], phone: r['SĐT']||r['Số điện thoại']||r['phone'] }));
      }
      renderPrecincts(); renderHouseholds(); renderSecurity(); updateStats(); alert('Import xong — kiểm tra dữ liệu.');
    });

    // Simple search
    document.getElementById('search-household').addEventListener('input', (e)=>{ const q = e.target.value.toLowerCase(); const tbody = document.getElementById('households-tbody'); Array.from(tbody.children).forEach(tr=>{ const text = tr.textContent.toLowerCase(); tr.style.display = text.includes(q) ? '' : 'none'; }); });
    document.getElementById('search-precinct').addEventListener('input', (e)=>{ const q = e.target.value.toLowerCase(); document.querySelectorAll('#precincts-list > div').forEach(card=>{ const txt = card.textContent.toLowerCase(); card.style.display = txt.includes(q) ? '' : 'none'; }); });

    function showHouseholdsForPrecinct(id){ const p = state.precincts.find(x=>String(x.id)===String(id)) || state.precincts[id] || {name: id}; document.querySelector('[data-tab="households"]').click(); document.getElementById('search-household').value = p.name; renderHouseholds(); const tbody = document.getElementById('households-tbody'); Array.from(tbody.children).forEach(tr=>{ const precinct = tr.children[3].textContent || ''; tr.style.display = precinct.includes(p.name) ? '' : 'none'; }); }

    // Supabase config UI
    document.getElementById('save-cfg').addEventListener('click', ()=>{ CONFIG.SUPABASE_URL = document.getElementById('cfg-url').value.trim(); CONFIG.SUPABASE_ANON_KEY = document.getElementById('cfg-key').value.trim(); if(!CONFIG.SUPABASE_URL||!CONFIG.SUPABASE_ANON_KEY) return alert('Nhập đầy đủ cấu hình'); supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY); localStorage.setItem('supabase_cfg', JSON.stringify(CONFIG)); alert('Lưu cấu hình xong. Bấm Kiểm tra kết nối.'); });
    document.getElementById('test-conn').addEventListener('click', async ()=>{ if(!supabase) return alert('Chưa lưu cấu hình Supabase'); try{ const { data, error } = await supabase.from('households').select('id').limit(1); if(error) throw error; alert('Kết nối thành công (bảng households tồn tại và có ' + (data? data.length:0) + ' mẫu).'); }catch(err){ console.error(err); alert('Lỗi kết nối hoặc bảng không tồn tại: '+err.message); } });

    // Auth: simple email sign-in (magic link) + signout
    document.getElementById('btn-signin').addEventListener('click', ()=>{ if(!supabase) return alert('Lưu cấu hình Supabase trước'); showModal('Đăng nhập', `<div class="grid gap-2"><label>Email</label><input id="auth-email" class="px-3 py-2 border rounded-md" placeholder="email@domain" /></div>`, async ()=>{ const email = document.getElementById('auth-email').value.trim(); if(!email) return alert('Nhập email'); const { error } = await supabase.auth.signInWithOtp({ email }); if(error) return alert('Lỗi gửi mail: '+error.message); alert('Đã gửi email đăng nhập (magic link). Kiểm tra hộp thư.'); }); });
    document.getElementById('btn-signout').addEventListener('click', async ()=>{ if(!supabase) return; await supabase.auth.signOut(); document.getElementById('btn-signout').classList.add('hidden'); document.getElementById('btn-signin').classList.remove('hidden'); alert('Đã đăng xuất'); });

    // Sync to Supabase: upsert households & security
    document.getElementById('btn-sync').addEventListener('click', async ()=>{
      if(!supabase) return alert('Lưu cấu hình Supabase trước'); if(!confirm('Gửi dữ liệu hiện tại lên Supabase (upsert theo cccd nếu có)?')) return;
      try{
        // Prepare households upsert (requires unique key on cccd or id)
        const hh = state.households.map(h=>({ owner: h.name, cccd: h.cccd||null, precinct: h.precinct, count: h.count||0 }));
        // Upsert (if table has unique constraint on cccd)
        if(hh.length) {
          const { error: err1 } = await supabase.from('households').upsert(hh, { onConflict: ['cccd'] });
          if(err1) throw err1;
        }
        const st = state.security.map(s=>({ precinct: s.precinct, name: s.name, cccd: s.cccd||null, role: s.role, phone: s.phone }));
        if(st.length){ const { error: err2 } = await supabase.from('security_team').upsert(st, { onConflict: ['cccd'] }); if(err2) throw err2; }
        alert('Đồng bộ xong. Kiểm tra bảng trong Supabase.');
      }catch(err){ console.error(err); alert('Lỗi khi đồng bộ: '+err.message); }
    });

    // Seed small sample (can be removed)
    (function seedSample(){ state.precincts = [{id:1,name:'Buôn Alê Gŏ'},{id:2,name:'Buôn Dhu'},{id:3,name:'Thôn 1A'}]; state.households = [{name:'Y ÑUT NIÊ', cccd:'064065002998', precinct:'Buôn Alê Gŏ', count:7},{name:'Y BLUM NIÊ', cccd:'066038002395', precinct:'Buôn Alê Gŏ', count:3},{name:'DƯƠNG ĐÌNH HÀ', cccd:'027093007243', precinct:'Buôn Dhu', count:4}]; state.security = [{precinct:'Thôn 5', name:'Bùi Quang Trung', cccd:'066067006242', role:'Tổ trưởng', phone:'0382260632'}]; renderPrecincts(); renderHouseholds(); renderSecurity(); updateStats(); })();

    /* Chart */
    let chart = null;
    function renderChart(){ const ctx = document.getElementById('chart-pop'); if(!ctx) return; const byPrec = {}; state.households.forEach(h=>{ const key = h.precinct||'Khác'; byPrec[key] = (byPrec[key]||0) + (Number(h.count)||0); }); const labels = Object.keys(byPrec).slice(0,10); const values = labels.map(l=>byPrec[l]); if(chart) chart.destroy(); chart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Số nhân khẩu theo thôn/buôn (top 10)', data: values }] }, options: { responsive:true } }); }

    // PWA: register service worker (simple)
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW registered')).catch(()=>console.log('SW failed')); }

    // Load saved config
    (function loadCfg(){ try{ const c = JSON.parse(localStorage.getItem('supabase_cfg')||'{}'); if(c.SUPABASE_URL) document.getElementById('cfg-url').value = c.SUPABASE_URL; if(c.SUPABASE_ANON_KEY) document.getElementById('cfg-key').value = c.SUPABASE_ANON_KEY; if(c.SUPABASE_URL && c.SUPABASE_ANON_KEY){ CONFIG = c; supabase = createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY); } }catch(e){console.warn('No cfg');} })();

    // Install PWA guidance
    document.getElementById('install-pwa').addEventListener('click', ()=>{ alert('Để cài PWA: mở menu trình duyệt -> Thêm vào màn hình chính (Android) hoặc vào biểu tượng chia sẻ -> Add to Home Screen.'); });

  </script>

  <!-- Fallback libs for non-module features: SheetJS & mammoth (only used via dynamic import above) -->

</body>
</html>
