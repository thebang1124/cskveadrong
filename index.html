<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hệ Thống Quản Lý Địa Bàn</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .tab-button{transition:all .2s ease-in-out; border-bottom-width:2px; border-bottom-color:transparent}
    .tab-button.active{color:#4f46e5; border-bottom-color:#4f46e5; font-weight:600}
  </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4">

  <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-slate-800 mb-6">Hệ Thống Quản Lý Địa Bàn</h1>

    <div id="tab-content">
      <!-- Precincts Section -->
      <div id="precincts-tab-content">
        <h2 class="text-2xl font-semibold mb-4">Danh sách Thôn, Buôn</h2>
        <div class="flex space-x-2 mb-4">
          <input id="new-precinct-name" type="text" placeholder="Tên thôn/buôn mới" class="flex-1 border rounded px-2 py-1" />
          <button id="add-precinct-btn" class="bg-green-600 text-white px-4 py-1 rounded">Thêm</button>
        </div>
        <ul id="precincts-list" class="list-disc pl-6 space-y-1 text-slate-700"></ul>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

    const SUPABASE_URL = 'https://skbjeeyisyfifzoiuxeq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...';

    const TABLES = { precincts: 'precincts' };

    let supabase = null;
    let userId = 'anonymous_' + Date.now();

    const initialPrecincts = [
      "Thôn 5","Thôn 6","Thôn 7","Thôn 8","Thôn 9",
      "Buôn Alê Gŏ","Buôn Dhu","Buôn Ea Kjŏh A","Buôn Ea Kjŏh B","Buôn Hně",
      "Buôn Kmiên","Buôn Pheo","Buôn Sǐng A","Buôn Tung Krăk","Buôn Trang",
      "Buôn Trăp","Buôn Tring 4","Thôn Đông Xuân","Thôn Ea Kung","Buôn Klat A",
      "Buôn Klat B","Buôn Klat C","Thôn Quyết Thắng","Thôn Tân Hợp","Thôn 1A",
      "Thôn 1B","Thôn 2A","Thôn 2B","Thôn 3","Thôn 6","Thôn 7","Thôn 8"
    ];

    async function initializeData(){
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // Xóa toàn bộ dữ liệu cũ
      await supabase.from(TABLES.precincts).delete().gt('id', 0);

      // Chèn lại 32 thôn/buôn trong một lần
      const rows = initialPrecincts.map(name => ({
        name,
        creator_id: userId,
        created_at: new Date().toISOString()
      }));
      await supabase.from(TABLES.precincts).insert(rows);

      fetchPrecincts();
    }

    async function fetchPrecincts(){
      const { data } = await supabase.from(TABLES.precincts).select('*').order('name');
      const list = document.getElementById('precincts-list');
      list.innerHTML = '';
      if(data){
        data.forEach(item=>{
          const li = document.createElement('li');
          li.className = 'flex justify-between items-center';
          li.innerHTML = `<span>${item.name}</span>
            <button class="delete-btn text-red-600 text-sm" data-id="${item.id}">Xóa</button>`;
          list.appendChild(li);
        });
      }
      attachDeleteListeners();
    }

    async function addPrecinct(name){
      if(!name) return;
      await supabase.from(TABLES.precincts).insert({ name, creator_id: userId, created_at: new Date().toISOString() });
      fetchPrecincts();
    }

    async function deletePrecinct(id){
      await supabase.from(TABLES.precincts).delete().eq('id',id);
      fetchPrecincts();
    }

    function attachDeleteListeners(){
      document.querySelectorAll('.delete-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id = btn.getAttribute('data-id');
          if(confirm('Bạn có chắc muốn xóa thôn/buôn này?')){
            deletePrecinct(id);
          }
        })
      });
    }

    document.getElementById('add-precinct-btn').addEventListener('click',()=>{
      const nameInput = document.getElementById('new-precinct-name');
      const name = nameInput.value.trim();
      if(name){
        addPrecinct(name);
        nameInput.value = '';
      }
    });

    initializeData();
  </script>
</body>
</html>
