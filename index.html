import React, { useState, useEffect } from 'react';

const dictionaryData = `
Từ Êđê,Nghĩa tiếng Việt
Kkuh,chào
Anăn,"tên, đấy, đó"
Kão,tôi (ngôi thứ nhất số ít)
Klei Êđê,tiếng Êđê
Ih,"anh, chị,...(ngôi thứ 2 số ít)"
Hlei,"ai, gì (khi hỏi tên)"
Dôk gũ,ngồi xuống
Suaih pral,mạnh khỏe
Kgũ dồng,đứng lên
Klei Yuăn,tiếng Kinh
Mtô,dạy
Pok,"mở, từ dùng đếm số trang, quyển"
Nai mtô,giáo viên
Mo,không (từ dùng để hỏi)
Hriăm,học
Amão,không
Hdruôm hră,quyển sách
Ti,"đâu, nào, tại"
Ti anôk,"ở đâu, chỗ nào"
Čiăng,muốn
Nao,đi
Ka,chưa
Ơ ơh,không (từ chối)
Mão,"có, được"
Hruê,ngày
Huă,ăn (cơm)"
Bồng,"ăn (bánh trái, canh)"
Knă,nấu
Abao (dt),Ốc bươu
Abăn (dt),Cái chăn (mền). Msăm abăn: đăp chăn; Abăn hmlei: Chăn bông.
Abŭ (dt),Cái hũ.
Adei (dt),Em.
Adĕ (dt),Hến.
Adham (dt),Một nhóm trong tộc người Êđê.
Adhan (dt),Cành. Adhan kyâo: Cành cây.
Adhei (dt),Trán. Adhei: Trán rộng.
Adiê (dt),Trời. Adiê hjan: Trời mưa.
Adih (đt),Kia. Sang kâo ti anôk adih: Nhà tôi chỗ kia; Hruê aguah ,Adih kâo đue# hiu: Sáng ngày kia tôi đi chơi.
Adôk (đgt),Còn. Kâo adôk prăk: Tôi còn tiền; Adôk hdyøp: Còn sống.
Adrăng (dt),Rơm rạ. Mkăm adrăng: đống rơm.
Adring (dt),"Hiên nhà sàn. Amyø kâo [hu mdiê ti adring: Mẹ tôi phơi luôa ở hiên nhà sàn."
Adrŏk (dt),Con cóc.
Aduôn (dt),Bà (nội
Adŭ (dt),1.Phòng. Adu\\ pyøt: Phòng ngủ; Adu\\
Yuôm (tt),1. Vô giá. Klei yuôm: Vô giá.
Yuôm bhăn (tt),1. Có giá trị. Klei yuôm bhăn: Vật có giá trị. 2. Trọng đại. Klei truh yuôm bhăn: Sự kiện trọng đại. 3. Cần thiết. Bruă yuôm bhăn: Việc cần thiết. 4. Quan trọng. Mnơng ngă yuôm bhăn: Biện pháp quan trọng. 5. Thiêng liêng.
Yuôm yĭn (tt),Đắt đỏ. Mnơng mnuă yuôm yyøn: hàng hóa đắt đỏ.
Yuôr (dt),Cây canh kina rừng.
Yuôt (đgt),Bám. Yuôt ti dhan kyâo hrut asei đyø kơ dlông: Bám cành cây đu người lên.
Yut yat (tt),Đung đưa.
Yŭ (dt),(Hướng) Tây. Angyøng mơng yu: Gió Tây.
Yŭ ngŏ (dt),Phương hướng. Amâo lo thâo yu ngo: Lạc mất phương hướng.
Yŭk (dt),"Đũng. Yu\\k ]hum: đũng quần."
Yŭm (tt),Mắn (nhiều)
Yŭn (đgt),Rung.
Yŭng jing (đgt),Đứng sững.
Yŭr (dt),Dái. Yŭr knga: Dái tai.
Yŭr tluôn (dt),Mông
Yưh yưp (tt),1. Chậm chạp. Eùbat yưh yưp: đi chậm chạp. 2. Lụn bại. Ai tiê yưh yưp...
`;

const App = () => {
    const [dictionary, setDictionary] = useState({});
    const [searchTerm, setSearchTerm] = useState('');
    const [loading, setLoading] = useState(true);
    const [loadingImage, setLoadingImage] = useState(false);
    const [imageResult, setImageResult] = useState('');
    const [imageFile, setImageFile] = useState(null);
    const [exampleResult, setExampleResult] = useState('');
    const [paragraphResult, setParagraphResult] = useState('');
    const [loadingExample, setLoadingExample] = useState(false);
    const [loadingParagraph, setLoadingParagraph] = useState(false);
    const [vnInput, setVnInput] = useState('');
    const [edeTranslation, setEdeTranslation] = useState('');
    const [loadingTranslation, setLoadingTranslation] = useState(false);

    const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent';
    const API_KEY = 'AIzaSyBVCTx8fPnGWFprwoT9bgixio_NUgvNG4k';

    // Hàm tiện ích để fetch API với chiến lược backoff theo cấp số nhân
    const exponentialBackoffFetch = async (url, options, retries = 3, delay = 1000) => {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            if (retries > 0) {
                await new Promise(res => setTimeout(res, delay));
                return exponentialBackoffFetch(url, options, retries - 1, delay * 2);
            } else {
                throw error;
            }
        }
    };

    // Hàm gọi Gemini API để tạo văn bản
    const generateText = async (prompt, setState, setLoadingState) => {
        setLoadingState(true);
        setState('');
        try {
            const payload = {
                contents: [{ role: 'user', parts: [{ text: prompt }] }]
            };
            const response = await exponentialBackoffFetch(`${GEMINI_API_URL}?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const text = response.candidates?.[0]?.content?.parts?.[0]?.text;
            setState(text || 'Không thể tạo nội dung.');
        } catch (error) {
            console.error("Lỗi khi tạo nội dung:", error);
            setState('Đã xảy ra lỗi khi tạo nội dung. Vui lòng thử lại.');
        } finally {
            setLoadingState(false);
        }
    };

    // Hàm gọi Gemini API để phân tích hình ảnh
    const analyzeImage = async (base64Image, prompt) => {
        setLoadingImage(true);
        setImageResult('');
        try {
            const payload = {
                contents: [
                    {
                        role: 'user',
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/jpeg', data: base64Image } }
                        ]
                    }
                ],
            };
            const response = await exponentialBackoffFetch(`${GEMINI_API_URL}?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const text = response.candidates?.[0]?.content?.parts?.[0]?.text;
            setImageResult(text || 'Không thể nhận diện văn bản trong ảnh.');
        } catch (error) {
            console.error("Lỗi khi phân tích ảnh:", error);
            setImageResult('Đã xảy ra lỗi khi phân tích ảnh. Vui lòng thử lại.');
        } finally {
            setLoadingImage(false);
        }
    };

    // Xử lý dịch từ tiếng Việt sang Êđê
    const handleTranslateVnToEde = () => {
        if (vnInput.trim() === '') {
            setEdeTranslation('Vui lòng nhập văn bản tiếng Việt để dịch.');
            return;
        }
        const prompt = `Dựa vào dữ liệu từ điển Êđê-Việt có sẵn, hãy dịch câu sau từ tiếng Việt sang tiếng Êđê: "${vnInput}". Chỉ trả về phần dịch, không thêm giải thích hay câu dẫn.`;
        generateText(prompt, setEdeTranslation, setLoadingTranslation);
    };

    // Phân tích dữ liệu từ điển thô
    useEffect(() => {
        try {
            const lines = dictionaryData.trim().split('\n');
            const parsedData = {};
            lines.forEach(line => {
                if (line.startsWith('Từ') || line.trim() === '') return;
                const firstCommaIndex = line.indexOf(',');
                if (firstCommaIndex === -1) return;
                const term = line.substring(0, firstCommaIndex).trim();
                const definition = line.substring(firstCommaIndex + 1).trim();
                if (term) {
                    parsedData[term] = definition;
                }
            });
            setDictionary(parsedData);
        } catch (error) {
            console.error("Lỗi khi phân tích dữ liệu từ điển:", error);
        } finally {
            setLoading(false);
        }
    }, []);

    // Lọc từ điển dựa trên từ khóa tìm kiếm
    const filteredWords = Object.keys(dictionary).filter(word =>
        word.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    // Xử lý tải ảnh lên
    const handleImageUpload = (event) => {
        const file = event.target.files[0];
        if (file) {
            setImageFile(file);
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64String = reader.result.split(',')[1];
                analyzeImage(base64String, "Dịch các từ tiếng Êđê trong hình ảnh này sang tiếng Việt. Giữ nguyên từ Êđê gốc và cung cấp nghĩa tiếng Việt tương ứng. Format: Từ Êđê: Nghĩa tiếng Việt");
            };
            reader.readAsDataURL(file);
        }
    };

    const handleGenerateExample = (word) => {
        const prompt = `Tạo 5 câu ví dụ tiếng Việt sử dụng từ Êđê '${word}' và cung cấp nghĩa tiếng Việt cho mỗi câu. Vui lòng định dạng dưới dạng danh sách gạch đầu dòng.`;
        generateText(prompt, setExampleResult, setLoadingExample);
    };

    const handleGenerateParagraph = (word) => {
        const prompt = `Viết một đoạn văn ngắn khoảng 50 từ bằng tiếng Việt, trong đó có sử dụng từ Êđê '${word}' và giải thích ý nghĩa của nó một cách tự nhiên.`;
        generateText(prompt, setParagraphResult, setLoadingParagraph);
    };

    return (
        <div className="min-h-screen bg-gray-100 flex items-start justify-center p-4 sm:p-6 md:p-8 font-sans">
            <div className="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-6 sm:p-8 space-y-8">
                
                {/* Header */}
                <div className="flex items-center justify-center space-x-3 text-emerald-600">
                    <i className="fa-solid fa-book-open fa-2xl"></i>
                    <h1 className="text-3xl sm:text-4xl font-extrabold tracking-tight">Từ điển Êđê - Việt</h1>
                </div>

                {/* Dictionary Search Section */}
                <div>
                    <h2 className="text-2xl font-bold text-gray-800 mb-4">Tra cứu từ</h2>
                    <div className="relative mb-4">
                        <i className="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input
                            type="text"
                            placeholder="Tìm kiếm từ..."
                            className="w-full pl-12 pr-4 py-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200 shadow-inner"
                            value={searchTerm}
                            onChange={(e) => setSearchTerm(e.target.value)}
                        />
                    </div>

                    {loading ? (
                        <div className="flex justify-center items-center h-48 text-gray-500">
                            <i className="fa-solid fa-spinner fa-spin fa-2xl"></i>
                        </div>
                    ) : (
                        <div className="h-[30vh] overflow-y-auto rounded-lg border border-gray-200 bg-gray-50 p-4 shadow-inner">
                            {filteredWords.length > 0 ? (
                                <ul className="space-y-4">
                                    {filteredWords.map(word => (
                                        <li key={word} className="bg-white p-4 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-200">
                                            <p className="text-xl font-bold text-emerald-700">{word}</p>
                                            <p className="text-gray-700 mt-1">
                                                {dictionary[word].startsWith('"') ? dictionary[word].slice(1, -1) : dictionary[word]}
                                            </p>
                                            <div className="mt-2 flex flex-wrap gap-2">
                                                <button
                                                    onClick={() => handleGenerateExample(word)}
                                                    className="bg-emerald-500 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-emerald-600 transition-colors"
                                                >
                                                    Tạo ví dụ
                                                </button>
                                                <button
                                                    onClick={() => handleGenerateParagraph(word)}
                                                    className="bg-sky-500 text-white px-4 py-2 rounded-full text-sm font-semibold hover:bg-sky-600 transition-colors"
                                                >
                                                    Tạo đoạn văn
                                                </button>
                                            </div>
                                        </li>
                                    ))}
                                </ul>
                            ) : (
                                <div className="text-center text-gray-500 py-10">
                                    <p className="text-lg">Không tìm thấy từ nào.</p>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* AI Features Section */}
                <div className="grid md:grid-cols-2 gap-8">
                    {/* Dịch Việt - Êđê */}
                    <div className="bg-gray-50 p-6 rounded-xl shadow-md">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <i className="fa-solid fa-language mr-2 text-emerald-600"></i> Dịch Việt - Êđê
                        </h2>
                        <textarea
                            className="w-full h-32 p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition-all duration-200 shadow-inner"
                            placeholder="Nhập văn bản tiếng Việt để dịch..."
                            value={vnInput}
                            onChange={(e) => setVnInput(e.target.value)}
                        ></textarea>
                        <button
                            onClick={handleTranslateVnToEde}
                            className="w-full mt-4 bg-emerald-500 text-white px-4 py-2 rounded-full font-semibold hover:bg-emerald-600 transition-colors"
                        >
                            Dịch sang Êđê
                        </button>
                        {loadingTranslation ? (
                            <div className="flex justify-center items-center h-24 mt-4">
                                <i className="fa-solid fa-spinner fa-spin text-emerald-500 fa-2xl"></i>
                            </div>
                        ) : edeTranslation && (
                            <div className="bg-white p-4 rounded-lg shadow border border-gray-200 mt-4">
                                <h3 className="font-semibold text-gray-700">Kết quả:</h3>
                                <p className="text-gray-600 mt-2 whitespace-pre-wrap">{edeTranslation}</p>
                            </div>
                        )}
                    </div>

                        {/* Dịch ảnh */}
                    <div className="bg-gray-50 p-6 rounded-xl shadow-md">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <i className="fa-solid fa-image mr-2 text-emerald-600"></i> Dịch ảnh
                        </h2>
                        <input
                            type="file"
                            accept="image/*"
                            onChange={handleImageUpload}
                            className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100 mb-4"
                        />
                        {loadingImage && (
                            <div className="flex justify-center items-center h-32">
                                <i className="fa-solid fa-spinner fa-spin text-emerald-500 fa-2xl"></i>
                            </div>
                        )}
                        {imageFile && (
                            <img src={URL.createObjectURL(imageFile)} alt="Preview" className="w-full max-h-48 object-contain rounded-lg mb-4" />
                        )}
                        {imageResult && (
                            <div className="bg-white p-4 rounded-lg shadow border border-gray-200 mt-4">
                                <h3 className="font-semibold text-gray-700">Kết quả:</h3>
                                <p className="text-gray-600 mt-2 whitespace-pre-wrap">{imageResult}</p>
                            </div>
                        )}
                    </div>
                </div>

                {/* Ví dụ & Đoạn văn Section */}
                <div className="grid md:grid-cols-2 gap-8">
                    <div className="bg-gray-50 p-6 rounded-xl shadow-md col-span-2">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                            <i className="fa-solid fa-lightbulb mr-2 text-emerald-600"></i> AI Tạo nội dung
                        </h2>
                        
                        <div className="space-y-4">
                            {loadingExample ? (
                                <div className="flex justify-center items-center h-24">
                                    <i className="fa-solid fa-spinner fa-spin text-emerald-500 fa-2xl"></i>
                                </div>
                            ) : exampleResult && (
                                <div className="bg-white p-4 rounded-lg shadow border border-gray-200">
                                    <h3 className="font-semibold text-emerald-700 flex items-center mb-2">
                                        <i className="fa-solid fa-lightbulb fa-xs mr-2"></i> Ví dụ:
                                    </h3>
                                    <p className="text-gray-600 whitespace-pre-wrap">{exampleResult}</p>
                                </div>
                            )}
                            
                            {loadingParagraph ? (
                                <div className="flex justify-center items-center h-24">
                                    <i className="fa-solid fa-spinner fa-spin text-emerald-500 fa-2xl"></i>
                                </div>
                            ) : paragraphResult && (
                                <div className="bg-white p-4 rounded-lg shadow border border-gray-200">
                                    <h3 className="font-semibold text-emerald-700 flex items-center mb-2">
                                        <i className="fa-solid fa-file-lines fa-xs mr-2"></i> Đoạn văn:
                                    </h3>
                                    <p className="text-gray-600 whitespace-pre-wrap">{paragraphResult}</p>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default App;
