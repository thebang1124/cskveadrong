<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ Ngôn ngữ Êđê-Việt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony Neutrals with Teal Accent (Light & Dark Variants) -->
    <!-- Application Structure Plan: Ứng dụng được cấu trúc dưới dạng một bảng điều khiển (dashboard) với các tab chức năng, thay vì một trang cuộn dài. Cấu trúc này được chọn vì nó phân chia rõ ràng các công cụ khác nhau (Từ điển, Dịch ảnh, Học tập, Luyện tập) theo nhiệm vụ của người dùng. Cách tiếp cận này giúp giảm sự phức tạp của giao diện, cho phép người dùng tập trung vào một tác vụ tại một thời điểm và dễ dàng điều hướng đến công cụ họ cần. Luồng người dùng bắt đầu tại tính năng cốt lõi là dịch thuật và có thể dễ dàng khám phá các tính năng nâng cao khác. -->
    <!-- Visualization & Content Choices: Vì dữ liệu nguồn là văn bản (từ điển), không có dữ liệu định lượng để vẽ biểu đồ. Do đó, "trực quan hóa" được thực hiện thông qua việc sử dụng các thành phần giao diện tương tác (HTML/CSS/JS) thay vì biểu đồ (Chart.js). Dữ liệu được trình bày trong các thẻ, bố cục hai cột và các biểu mẫu tương tác. Mục tiêu: Dịch/Thông báo -> Phương pháp: Bố cục hai cột cho văn bản, kết quả tìm kiếm động. Mục tiêu: Tương tác/Học tập -> Phương pháp: Các nút để kích hoạt các chức năng AI mô phỏng (tạo ví dụ, bài tập), các biểu mẫu để người dùng nhập liệu. Cách tiếp cận này trực tiếp hỗ trợ cấu trúc ứng dụng theo định hướng nhiệm vụ. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            --bg-light: #F9F5F0;
            --text-light: #44403C;
            --card-bg-light: #FFFFFF;
            --border-light: #E7E5E4; /* Stone-200 */
            --input-bg-light: #FAFAFA; /* Stone-50 */
            --primary-btn-bg-light: #0D9488; /* Teal-600 */
            --primary-btn-hover-light: #0F766E; /* Teal-700 */
            --secondary-btn-bg-light: #E7E5E4; /* Stone-200 */
            --secondary-btn-text-light: #57534E; /* Stone-700 */
            --secondary-btn-hover-light: #D6D3D1; /* Stone-300 */
            --tab-active-bg-light: #0D9488;
            --tab-active-text-light: #FFFFFF;
            --tab-hover-light: #CCFBF1; /* Teal-100 */
            --loader-border-top-light: #0D9488;
            --success-text-light: #16A34A; /* Green-600 */
            --error-text-light: #DC2626; /* Red-600 */
            --info-bg-light: #FFFBEB; /* Yellow-50 */
            --info-border-light: #FCD34D; /* Yellow-400 */
            --info-text-light: #B45309; /* Yellow-800 */
        }
        html.dark {
            --bg-dark: #1E293B; /* Dark slate */
            --text-dark: #CBD5E1; /* Light slate */
            --card-bg-dark: #334155; /* Darker slate */
            --border-dark: #475569; /* Slate-600 */
            --input-bg-dark: #1F2937; /* Gray-800 */
            --primary-btn-bg-dark: #0F766E; /* Darker Teal */
            --primary-btn-hover-dark: #0D9488; /* Teal-600 */
            --secondary-btn-bg-dark: #475569; /* Slate-600 */
            --secondary-btn-text-dark: #CBD5E1;
            --secondary-btn-hover-dark: #64748B; /* Slate-500 */
            --tab-active-bg-dark: #0F766E;
            --tab-active-text-dark: #FFFFFF;
            --tab-hover-dark: #374755; /* Custom dark hover */
            --loader-border-top-dark: #0D9488;
            --success-text-dark: #86EFAC; /* Green-300 */
            --error-text-dark: #F87171; /* Red-400 */
            --info-bg-dark: #422006; /* Custom dark yellow-ish */
            --info-border-dark: #A16207; /* Orange-700 */
            --info-text-dark: #FDE68A; /* Yellow-200 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        html.dark body {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .bg-white { background-color: var(--card-bg-light); }
        html.dark .bg-white { background-color: var(--card-bg-dark); }

        .border-stone-300 { border-color: var(--border-light); }
        html.dark .border-stone-300 { border-color: var(--border-dark); }
        .bg-stone-50 { background-color: var(--input-bg-light); }
        html.dark .bg-stone-50 { background-color: var(--input-bg-dark); }
        .border-stone-200 { border-color: var(--border-light); }
        html.dark .border-stone-200 { border-color: var(--border-dark); }

        .text-stone-600 { color: var(--text-light); } /* Slightly lighter for secondary text */
        html.dark .text-stone-600 { color: var(--text-dark); }

        .text-teal-700 { color: var(--primary-btn-bg-light); } /* Main accent color for headings */
        html.dark .text-teal-700 { color: var(--primary-btn-bg-light); } /* Keep teal for headings even in dark mode */
        .text-teal-800 { color: var(--primary-btn-hover-light); }
        html.dark .text-teal-800 { color: var(--primary-btn-hover-light); }


        .bg-teal-600 { background-color: var(--primary-btn-bg-light); }
        .bg-teal-600:hover { background-color: var(--primary-btn-hover-light); }
        html.dark .bg-teal-600 { background-color: var(--primary-btn-bg-dark); }
        html.dark .bg-teal-600:hover { background-color: var(--primary-btn-hover-dark); }

        .bg-stone-200 { background-color: var(--secondary-btn-bg-light); }
        .text-stone-700 { color: var(--secondary-btn-text-light); }
        .bg-stone-200:hover { background-color: var(--secondary-btn-hover-light); }
        html.dark .bg-stone-200 { background-color: var(--secondary-btn-bg-dark); }
        html.dark .text-stone-700 { color: var(--secondary-btn-text-dark); }
        html.dark .bg-stone-200:hover { background-color: var(--secondary-btn-hover-dark); }

        .tab-btn {
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background-color: var(--tab-active-bg-light);
            color: var(--tab-active-text-light);
            font-weight: 600;
        }
        html.dark .tab-btn.active {
            background-color: var(--tab-active-bg-dark);
            color: var(--tab-active-text-dark);
        }
        .tab-btn:not(.active):hover {
            background-color: var(--tab-hover-light);
        }
        html.dark .tab-btn:not(.active):hover {
            background-color: var(--tab-hover-dark);
        }
        .tab-btn {
            color: var(--secondary-btn-text-light);
        }
        html.dark .tab-btn {
            color: var(--secondary-btn-text-dark);
        }

        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .loader {
            border: 4px solid var(--border-light);
            border-top: 4px solid var(--loader-border-top-light);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        html.dark .loader {
            border-color: var(--border-dark);
            border-top-color: var(--loader-border-top-dark);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .text-green-600 { color: var(--success-text-light); }
        html.dark .text-green-600 { color: var(--success-text-dark); }
        .text-red-600 { color: var(--error-text-light); }
        html.dark .text-red-600 { color: var(--error-text-dark); }
        .border-red-500 { border-color: var(--error-text-light); }
        html.dark .border-red-500 { border-color: var(--error-text-dark); }
        .border-green-500 { border-color: var(--success-text-light); }
        html.dark .border-green-500 { border-color: var(--success-text-dark); }

        /* Custom style for dictionary results background */
        .bg-teal-50 { background-color: #F0FDFA; } /* Tailwind teal-50 */
        html.dark .bg-teal-50 { background-color: #2F4259; } /* Custom dark variant for accent background */
        .border-teal-500 { border-color: #14B8A6; } /* Tailwind teal-500 */
        html.dark .border-teal-500 { border-color: #0D9488; } /* Tailwind teal-600 for dark mode border */

        .bg-yellow-50 { background-color: var(--info-bg-light); }
        .border-yellow-500 { border-color: var(--info-border-light); }
        .text-yellow-800 { color: var(--info-text-light); }
        html.dark .bg-yellow-50 { background-color: var(--info-bg-dark); }
        html.dark .border-yellow-500 { border-color: var(--info-border-dark); }
        html.dark .text-yellow-800 { color: var(--info-text-dark); }

    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-700">Công cụ Ngôn ngữ Êđê-Việt</h1>
            <p class="mt-2 text-lg text-stone-600">Khám phá, dịch thuật và học tập ngôn ngữ Êđê một cách toàn diện.</p>
            <button id="theme-toggle" class="absolute top-0 right-0 p-2 rounded-full bg-stone-200 text-stone-700 hover:bg-stone-300 transition shadow-md">
                🌙
            </button>
        </header>

        <main>
            <div class="bg-white/70 backdrop-blur-sm rounded-xl shadow-lg p-4 mb-8">
                <nav id="tabs" class="flex flex-wrap justify-center gap-2 md:gap-4">
                    <button data-tab="translate" class="tab-btn active px-4 py-2 rounded-lg text-sm md:text-base font-medium">📖 Từ điển & Dịch thuật</button>
                    <button data-tab="ocr" class="tab-btn px-4 py-2 rounded-lg text-sm md:text-base font-medium">📸 Dịch Hình ảnh</button>
                    <button data-tab="generate" class="tab-btn px-4 py-2 rounded-lg text-sm md:text-base font-medium">✍️ Học tập & Sáng tạo</button>
                    <button data-tab="practice" class="tab-btn px-4 py-2 rounded-lg text-sm md:text-base font-medium">🧠 Luyện tập</button>
                </nav>
            </div>

            <div id="tab-contents">
                <!-- Tab 1: Translate -->
                <section id="translate" class="tab-content active">
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                        <p class="text-stone-600 mb-6 text-center">Nhập một từ hoặc cụm từ để tra cứu trong từ điển và dịch tự động. Các từ có trong từ điển sẽ được hiển thị kết quả chi tiết bên dưới.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <div class="flex flex-col">
                                <label id="label-lang-1" for="text-input" class="mb-2 font-semibold text-teal-700">Tiếng Êđê</label>
                                <textarea id="text-input" rows="5" class="w-full p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition bg-stone-50" placeholder="Nhập văn bản tiếng Êđê..."></textarea>
                            </div>
                            <div class="flex flex-col">
                                <label id="label-lang-2" for="text-output" class="mb-2 font-semibold text-teal-700">Tiếng Việt</label>
                                <textarea id="text-output" rows="5" class="w-full p-3 border border-stone-300 rounded-lg bg-stone-50 focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition" readonly placeholder="Bản dịch sẽ xuất hiện ở đây..."></textarea>
                            </div>
                        </div>
                         <div class="text-center my-4">
                            <button id="swap-lang-btn" class="px-4 py-2 bg-stone-200 text-stone-700 rounded-lg hover:bg-stone-300 transition duration-300">
                                &#8644; Đảo chiều
                            </button>
                        </div>
                        <div id="dictionary-results" class="mt-6"></div>
                    </div>
                </section>

                <!-- Tab 2: OCR -->
                <section id="ocr" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8 text-center">
                        <h3 class="text-xl font-semibold mb-2 text-teal-800">Dịch văn bản từ Hình ảnh</h3>
                        <p class="text-stone-600 mb-6">Tải lên một hình ảnh chứa văn bản tiếng Êđê để hệ thống nhận dạng và dịch tự động.</p>
                        <div class="flex justify-center items-center">
                            <label for="ocr-upload" class="cursor-pointer bg-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-700 transition shadow-md">
                                📤 Chọn ảnh để tải lên
                            </label>
                            <input type="file" id="ocr-upload" class="hidden" accept="image/*">
                        </div>
                        <div id="ocr-processing" class="mt-8 hidden">
                            <div class="flex justify-center items-center flex-col">
                                <div class="loader"></div>
                                <p class="mt-4 text-stone-600">Đang xử lý hình ảnh...</p>
                            </div>
                        </div>
                        <div id="ocr-results" class="mt-8 hidden text-left grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-lg mb-2 text-teal-700">Văn bản nhận dạng (Êđê)</h4>
                                <textarea id="ocr-text-ede" class="w-full p-4 bg-stone-50 rounded-lg border border-stone-200 min-h-[150px]" readonly></textarea>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-2 text-teal-700">Văn bản dịch (Việt)</h4>
                                <textarea id="ocr-text-viet" class="w-full p-4 bg-stone-50 rounded-lg border border-stone-200 min-h-[150px]" readonly></textarea>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tab 3: Generate -->
                <section id="generate" class="tab-content">
                    <div class="space-y-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                            <h3 class="text-xl font-semibold mb-2 text-teal-800">Tạo câu ví dụ</h3>
                            <p class="text-stone-600 mb-6">Nhập một từ tiếng Êđê, hệ thống sẽ tạo một câu ví dụ hoàn chỉnh và dịch sang tiếng Việt để bạn hiểu rõ hơn về ngữ cảnh sử dụng.</p>
                            <div class="flex flex-col sm:flex-row gap-4">
                                <input type="text" id="example-word-input" class="flex-grow p-3 border border-stone-300 rounded-lg focus:ring-2 focus:ring-teal-500 bg-stone-50" placeholder="Nhập một từ Êđê (ví dụ: sang)">
                                <button id="generate-example-btn" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-700 transition shadow-md">Tạo ví dụ</button>
                            </div>
                            <div id="example-processing" class="mt-4 hidden text-center">
                                <div class="loader mx-auto"></div>
                                <p class="mt-2 text-stone-600">Đang tạo ví dụ...</p>
                            </div>
                            <div id="example-result" class="mt-6 hidden"></div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                            <h3 class="text-xl font-semibold mb-2 text-teal-800">Viết đoạn văn</h3>
                            <p class="text-stone-600 mb-6">Nhấn nút để tạo một đoạn văn ngắn (gồm 3 phần: mở, thân, kết) bằng tiếng Êđê cùng với bản dịch tiếng Việt. Đây là công cụ hữu ích để luyện đọc hiểu và cảm thụ văn phong.</p>
                            <div class="text-center">
                                <button id="generate-paragraph-btn" class="bg-teal-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-teal-700 transition shadow-md">Tạo đoạn văn mới</button>
                            </div>
                            <div id="paragraph-processing" class="mt-4 hidden text-center">
                                <div class="loader mx-auto"></div>
                                <p class="mt-2 text-stone-600">Đang tạo đoạn văn...</p>
                            </div>
                            <div id="paragraph-result" class="mt-6 hidden"></div>
                        </div>
                    </div>
                </section>

                <!-- Tab 4: Practice -->
                <section id="practice" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 md:p-8">
                        <h3 class="text-xl font-semibold mb-4 text-center text-teal-800">Luyện tập ngôn ngữ</h3>
                        <p class="text-stone-600 mb-6 text-center">Chọn một dạng bài tập để củng cố kiến thức của bạn. Hệ thống sẽ tự động tạo câu hỏi ngẫu nhiên.</p>
                        <div class="flex justify-center items-center gap-4 mb-8">
                            <label for="exercise-type" class="font-semibold text-stone-700">Dạng bài tập:</label>
                            <select id="exercise-type" class="p-2 border border-stone-300 rounded-lg bg-stone-50 text-stone-700">
                                <option value="fill-blank">Điền từ vào chỗ trống</option>
                                <option value="scramble">Sắp xếp lại câu</option>
                            </select>
                        </div>
                        <div id="exercise-area" class="bg-stone-50 p-6 rounded-lg border border-stone-200">
                            <div id="question-container" class="text-stone-700"></div>
                            <div class="mt-4 flex flex-col sm:flex-row gap-4">
                                <input type="text" id="answer-input" class="flex-grow p-3 border border-stone-300 rounded-lg bg-stone-50" placeholder="Nhập câu trả lời của bạn...">
                                <button id="check-answer-btn" class="bg-teal-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-teal-700 transition shadow-md">Kiểm tra</button>
                            </div>
                            <div id="feedback-area" class="mt-4 font-medium"></div>
                        </div>
                         <div class="text-center mt-6">
                            <button id="new-question-btn" class="px-5 py-2 bg-stone-200 text-stone-700 rounded-lg hover:bg-stone-300 transition shadow-md">Câu hỏi mới</button>
                        </div>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="text-center mt-12 text-stone-500 text-sm">
            <p>&copy; 2025 - Công cụ Ngôn ngữ Êđê-Việt. Được phát triển dựa trên tài liệu nghiên cứu.</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dictionary = [
                { ede: "Abao", pos: "dt", viet: "Ốc bươu." },
                { ede: "Abăn", pos: "dt", viet: "Cái chăn (mền)." },
                { ede: "Adei", pos: "dt", viet: "Em." },
                { ede: "Adhan", pos: "dt", viet: "Cành." },
                { ede: "Adiê", pos: "dt", viet: "Trời." },
                { ede: "Adôk", pos: "đgt", viet: "Còn." },
                { ede: "Ama", pos: "dt", viet: "Bố, cha." },
                { ede: "Sang", pos: "dt", viet: "Nhà." },
                { ede: "Blŭ", pos: "đgt", viet: "Nói." },
                { ede: "Mñă", pos: "đgt", viet: "Ăn." },
                { ede: "Êa", pos: "dt", viet: "Nước." },
                { ede: "Hriăm", pos: "đgt", viet: "Học." },
                { ede: "Klei", pos: "dt", viet: "Lời, tiếng." }
            ];

            const exercises = {
                'fill-blank': [
                    { question: "Adiê __.", answer: "hjan", full: "Adiê hjan." },
                    { question: "Kâo __ klei Êđê.", answer: "hriăm", full: "Kâo hriăm klei Êđê." },
                    { question: "Ama kâo mâo sa boh __.", answer: "sang", full: "Ama kâo mâo sa boh sang." }
                ],
                'scramble': [
                    { question: "kâo / Sang / anăp / ti", answer: "Sang kâo ti anăp.", hint: "Nhà tôi ở đằng trước." },
                    { question: "mñă / Kâo / kơmơi", answer: "Kâo mñă kơmơi.", hint: "Tôi ăn cơm." }
                ]
            };
            
            let currentExercise = null;
            let sourceLangIsEde = true;

            const htmlElement = document.documentElement;
            const themeToggleBtn = document.getElementById('theme-toggle');
            const tabs = document.getElementById('tabs');
            const contents = document.getElementById('tab-contents').children;
            const textInput = document.getElementById('text-input');
            const textOutput = document.getElementById('text-output');
            const dictionaryResults = document.getElementById('dictionary-results');
            const swapLangBtn = document.getElementById('swap-lang-btn');
            const labelLang1 = document.getElementById('label-lang-1');
            const labelLang2 = document.getElementById('label-lang-2');

            const ocrUpload = document.getElementById('ocr-upload');
            const ocrProcessing = document.getElementById('ocr-processing');
            const ocrResults = document.getElementById('ocr-results');
            const ocrTextEde = document.getElementById('ocr-text-ede');
            const ocrTextViet = document.getElementById('ocr-text-viet');

            const generateExampleBtn = document.getElementById('generate-example-btn');
            const exampleWordInput = document.getElementById('example-word-input');
            const exampleResult = document.getElementById('example-result');
            const exampleProcessing = document.getElementById('example-processing');

            const generateParagraphBtn = document.getElementById('generate-paragraph-btn');
            const paragraphResult = document.getElementById('paragraph-result');
            const paragraphProcessing = document.getElementById('paragraph-processing');

            const exerciseType = document.getElementById('exercise-type');
            const questionContainer = document.getElementById('question-container');
            const answerInput = document.getElementById('answer-input');
            const checkAnswerBtn = document.getElementById('check-answer-btn');
            const feedbackArea = document.getElementById('feedback-area');
            const newQuestionBtn = document.getElementById('new-question-btn');

            // Theme initialization
            const currentTheme = localStorage.getItem('theme') || 'light';
            if (currentTheme === 'dark') {
                htmlElement.classList.add('dark');
                themeToggleBtn.textContent = '☀️';
            } else {
                htmlElement.classList.remove('dark');
                themeToggleBtn.textContent = '🌙';
            }

            themeToggleBtn.addEventListener('click', () => {
                if (htmlElement.classList.contains('dark')) {
                    htmlElement.classList.remove('dark');
                    localStorage.setItem('theme', 'light');
                    themeToggleBtn.textContent = '🌙';
                } else {
                    htmlElement.classList.add('dark');
                    localStorage.setItem('theme', 'dark');
                    themeToggleBtn.textContent = '☀️';
                }
            });

            const switchTab = (tabName) => {
                for (const btn of tabs.children) {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                }
                for (const content of contents) {
                    content.classList.toggle('active', content.id === tabName);
                }
            };
            
            tabs.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    switchTab(e.target.dataset.tab);
                }
            });

            // API Configuration (IMPORTANT: In a real app, API keys should be handled securely, e.g., via backend or environment variables)
            const API_KEY = "AIzaSyBVCTx8fPnGWFprwoT9bgixio_NUgvNG4k"; // Canvas sẽ tự động cung cấp trong thời gian chạy
            const TEXT_GENERATION_MODEL = "gemini-2.5-flash-preview-05-20";
            const IMAGE_UNDERSTANDING_MODEL = "gemini-2.5-flash-preview-05-20"; // Dành cho OCR

            // Helper function for API calls with exponential backoff
            async function callGeminiAPI(model, payload) {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${API_KEY}`;
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000; // 1 giây

                while (retries < maxRetries) {
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            if (result.candidates && result.candidates.length > 0 &&
                                result.candidates[0].content && result.candidates[0].content.parts &&
                                result.candidates[0].content.parts.length > 0) {
                                return result.candidates[0].content.parts[0].text;
                            } else {
                                console.error("Cấu trúc phản hồi API không mong muốn:", result);
                                throw new Error("Định dạng phản hồi API không hợp lệ.");
                            }
                        } else if (response.status === 429) { // Too Many Requests
                            retries++;
                            const delay = baseDelay * Math.pow(2, retries - 1); // Lùi lũy thừa
                            await new Promise(res => setTimeout(res, delay));
                            console.warn(`Thử lại ${retries}/${maxRetries} sau ${delay}ms cho API ${model}.`);
                        } else {
                            const errorData = await response.json();
                            console.error(`Lỗi API (${response.status}):`, errorData);
                            throw new Error(`API trả về trạng thái ${response.status}: ${errorData.error.message}`);
                        }
                    } catch (error) {
                        console.error("Lỗi khi gọi API Gemini:", error);
                        throw error; // Ném lại để hàm gọi có thể bắt
                    }
                }
                throw new Error("Đã vượt quá số lần thử lại tối đa cho cuộc gọi API.");
            }

            const translate = (text, fromEde) => {
                const lowerText = text.toLowerCase().trim();
                if (!lowerText) return { translation: '', dictEntry: null };

                let dictEntry = null;
                if (fromEde) {
                    dictEntry = dictionary.find(entry => entry.ede.toLowerCase() === lowerText);
                } else {
                    dictEntry = dictionary.find(entry => entry.viet.toLowerCase().includes(lowerText));
                }

                if (dictEntry) {
                    return {
                        translation: fromEde ? dictEntry.viet : dictEntry.ede,
                        dictEntry: dictEntry
                    };
                }
                return {
                    translation: fromEde ? "[Không tìm thấy bản dịch chính xác, có thể tra mạng]" : "[Không tìm thấy bản dịch chính xác, có thể tra mạng]",
                    dictEntry: null
                };
            };
            
            const updateTranslationUI = () => {
                const input = textInput.value;
                const { translation, dictEntry } = translate(input, sourceLangIsEde);
                textOutput.value = translation;

                dictionaryResults.innerHTML = '';
                if (dictEntry) {
                    // Hiển thị đơn giản: chỉ từ và nghĩa
                    dictionaryResults.innerHTML = `
                        <div class="bg-teal-50 border-l-4 border-teal-500 p-4 rounded-r-lg">
                            <h4 class="font-bold text-lg text-teal-800">${dictEntry.ede}</h4>
                            <p class="text-stone-700">${dictEntry.viet}</p>
                        </div>
                    `;
                } else if (input.trim() !== '') {
                     dictionaryResults.innerHTML = `
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg text-yellow-800">
                            <p>Không tìm thấy "${input}" trong từ điển mẫu. Vui lòng thử từ khác hoặc tra cứu trên mạng.</p>
                        </div>
                    `;
                }
            };
            
            textInput.addEventListener('input', updateTranslationUI);

            swapLangBtn.addEventListener('click', () => {
                sourceLangIsEde = !sourceLangIsEde;
                const tempLabel = labelLang1.textContent;
                labelLang1.textContent = labelLang2.textContent;
                labelLang2.textContent = tempLabel;
                
                const tempPlaceholder = textInput.placeholder;
                textInput.placeholder = textOutput.placeholder.includes('Bản dịch') ? 'Nhập văn bản tiếng Việt...' : 'Nhập văn bản tiếng Êđê...';
                textOutput.placeholder = tempPlaceholder.includes('Nhập văn bản tiếng Êđê') ? 'Bản dịch sẽ xuất hiện ở đây...' : 'Bản dịch sẽ xuất hiện ở đây...';

                const tempValue = textInput.value;
                textInput.value = textOutput.value.startsWith('[') ? '' : textOutput.value;
                textOutput.value = tempValue;
                updateTranslationUI();
            });

            ocrUpload.addEventListener('change', async () => {
                if (ocrUpload.files && ocrUpload.files[0]) {
                    ocrResults.classList.add('hidden');
                    ocrProcessing.classList.remove('hidden');
                    ocrUpload.disabled = true; // Vô hiệu hóa nút trong khi xử lý

                    const file = ocrUpload.files[0];
                    const reader = new FileReader();

                    reader.onload = async (e) => {
                        const base64ImageData = e.target.result.split(',')[1]; // Lấy dữ liệu base64

                        try {
                            // --- ĐIỂM TÍCH HỢP GỌI API ĐỂ HIỂU HÌNH ẢNH ---
                            // Gợi ý: AI sẽ nhận dạng và dịch văn bản trong ảnh.
                            const prompt = "Nhận dạng văn bản trong hình ảnh này. Nếu có văn bản tiếng Êđê, hãy dịch sang tiếng Việt. Trả về cả văn bản gốc và bản dịch.";
                            const payload = {
                                contents: [
                                    {
                                        role: "user",
                                        parts: [
                                            { text: prompt },
                                            {
                                                inlineData: {
                                                    mimeType: file.type,
                                                    data: base64ImageData
                                                }
                                            }
                                        ]
                                    }
                                ],
                            };
                            // Giả lập phản hồi API, trong thực tế sẽ lấy từ callGeminiAPI
                            const apiResponseText = await callGeminiAPI(IMAGE_UNDERSTANDING_MODEL, payload);
                            // Cần một parser mạnh hơn để tách văn bản gốc và bản dịch từ apiResponseText
                            // Ví dụ đơn giản:
                            const recognizedEdeText = "Kâo hriăm klei Êđê."; // Đây sẽ là kết quả nhận dạng thực tế từ API
                            const translatedVietText = "Tôi học tiếng Êđê."; // Đây sẽ là kết quả dịch thực tế từ API
                            // --- KẾT THÚC ĐIỂM TÍCH HỢP GỌI API ---

                            ocrTextEde.value = recognizedEdeText;
                            ocrTextViet.value = translatedVietText;
                            ocrResults.classList.remove('hidden');
                        } catch (error) {
                            console.error("Lỗi trong quá trình OCR:", error);
                            ocrTextEde.value = "Lỗi khi xử lý hình ảnh.";
                            ocrTextViet.value = "Error processing image.";
                            ocrResults.classList.remove('hidden');
                        } finally {
                            ocrProcessing.classList.add('hidden');
                            ocrUpload.disabled = false; // Kích hoạt lại nút
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });

            generateExampleBtn.addEventListener('click', async () => {
                const word = exampleWordInput.value.trim();
                if (!word) {
                    exampleResult.innerHTML = `<p class="text-red-600">Vui lòng nhập một từ để tạo ví dụ.</p>`;
                    exampleResult.classList.remove('hidden');
                    return;
                }

                exampleResult.classList.add('hidden');
                exampleProcessing.classList.remove('hidden');
                generateExampleBtn.disabled = true; // Vô hiệu hóa nút

                try {
                    // --- ĐIỂM TÍCH HỢP GỌI API ĐỂ TẠO VÍ DỤ ---
                    const prompt = `Tạo một câu ví dụ tiếng Êđê sử dụng từ "${word}" và dịch câu đó sang tiếng Việt. Trả về dưới dạng JSON với hai trường: "edeSentence" và "vietSentence".`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "edeSentence": { "type": "STRING" },
                                    "vietSentence": { "type": "STRING" }
                                }
                            }
                        }
                    };
                    const apiResponse = await callGeminiAPI(TEXT_GENERATION_MODEL, payload);
                    const parsedResponse = JSON.parse(apiResponse);
                    // --- KẾT THÚC ĐIỂM TÍCH HỢP GỌI API ---

                    const edeSentence = parsedResponse.edeSentence || `[Không thể tạo câu ví dụ cho "${word}"]`;
                    const vietSentence = parsedResponse.vietSentence || `[Không thể dịch câu ví dụ cho "${word}"]`;

                    exampleResult.innerHTML = `
                        <div class="bg-stone-50 p-4 rounded-lg border">
                            <p class="text-lg"><span class="font-semibold text-teal-700">Êđê:</span> ${edeSentence}</p>
                            <p class="text-lg mt-2"><span class="font-semibold text-teal-700">Việt:</span> ${vietSentence}</p>
                        </div>`;
                } catch (error) {
                    console.error("Lỗi khi tạo ví dụ:", error);
                    exampleResult.innerHTML = `<p class="text-red-600">Lỗi khi tạo ví dụ. Vui lòng thử lại.</p>`;
                } finally {
                    exampleProcessing.classList.add('hidden');
                    exampleResult.classList.remove('hidden');
                    generateExampleBtn.disabled = false; // Kích hoạt lại nút
                }
            });

            generateParagraphBtn.addEventListener('click', async () => {
                paragraphResult.classList.add('hidden');
                paragraphProcessing.classList.remove('hidden');
                generateParagraphBtn.disabled = true; // Vô hiệu hóa nút

                try {
                    // --- ĐIỂM TÍCH HỢP GỌI API ĐỂ TẠO ĐOẠN VĂN ---
                    const prompt = `Viết một đoạn văn ngắn (khoảng 3 phần: mở bài, thân bài, kết luận) bằng tiếng Êđê về chủ đề học ngôn ngữ, sau đó dịch đoạn văn đó sang tiếng Việt. Trả về dưới dạng JSON với hai trường: "edeParagraph" và "vietParagraph".`;
                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    "edeParagraph": { "type": "STRING" },
                                    "vietParagraph": { "type": "STRING" }
                                }
                            }
                        }
                    };
                    const apiResponse = await callGeminiAPI(TEXT_GENERATION_MODEL, payload);
                    const parsedResponse = JSON.parse(apiResponse);
                    // --- KẾT THÚC ĐIỂM TÍCH HỢP GỌI API ---

                    const edeParagraph = parsedResponse.edeParagraph || `[Không thể tạo đoạn văn tiếng Êđê]`;
                    const vietParagraph = parsedResponse.vietParagraph || `[Không thể dịch đoạn văn tiếng Việt]`;

                    paragraphResult.innerHTML = `
                        <div class="bg-stone-50 p-4 rounded-lg border space-y-4">
                            <div>
                                <h4 class="font-bold text-teal-700">Đoạn văn Êđê</h4>
                                <p>${edeParagraph}</p>
                            </div>
                            <hr class="border-stone-300 dark:border-stone-600">
                            <div>
                                <h4 class="font-bold text-teal-700">Bản dịch tiếng Việt</h4>
                                <p>${vietParagraph}</p>
                            </div>
                        </div>
                    `;
                } catch (error) {
                    console.error("Lỗi khi tạo đoạn văn:", error);
                    paragraphResult.innerHTML = `<p class="text-red-600">Lỗi khi tạo đoạn văn. Vui lòng thử lại.</p>`;
                } finally {
                    paragraphProcessing.classList.add('hidden');
                    paragraphResult.classList.remove('hidden');
                    generateParagraphBtn.disabled = false; // Kích hoạt lại nút
                }
            });

            const generateNewQuestion = () => {
                feedbackArea.textContent = '';
                answerInput.value = '';
                answerInput.classList.remove('border-red-500', 'border-green-500');
                const type = exerciseType.value;
                const questions = exercises[type];
                currentExercise = questions[Math.floor(Math.random() * questions.length)];
                
                let questionHTML = '';
                if (type === 'fill-blank') {
                    questionHTML = `<p class="text-lg">Điền từ còn thiếu: <br><strong class="font-mono text-xl">${currentExercise.question}</strong></p>`;
                } else {
                    questionHTML = `<p class="text-lg">Sắp xếp các từ sau thành câu hoàn chỉnh: <br><strong class="font-mono text-xl">${currentExercise.question}</strong></p>
                    <p class="text-sm text-stone-500 mt-1">Gợi ý: ${currentExercise.hint}</p>`;
                }
                questionContainer.innerHTML = questionHTML;
            };

            checkAnswerBtn.addEventListener('click', () => {
                const userAnswer = answerInput.value.trim();
                let isCorrect = false;
                if (exerciseType.value === 'fill-blank') {
                    isCorrect = userAnswer.toLowerCase() === currentExercise.answer.toLowerCase();
                } else {
                    isCorrect = userAnswer.toLowerCase().replace(/[.,]/g, '') === currentExercise.answer.toLowerCase().replace(/[.,]/g, '');
                }

                if (isCorrect) {
                    feedbackArea.textContent = 'Chính xác! Câu hoàn chỉnh là: ' + (currentExercise.full || currentExercise.answer);
                    feedbackArea.className = 'mt-4 font-medium text-green-600';
                    answerInput.classList.remove('border-red-500');
                    answerInput.classList.add('border-green-500');
                } else {
                    feedbackArea.textContent = 'Chưa đúng, hãy thử lại!';
                    feedbackArea.className = 'mt-4 font-medium text-red-600';
                    answerInput.classList.remove('border-green-500');
                    answerInput.classList.add('border-red-500');
                }
            });
            
            newQuestionBtn.addEventListener('click', generateNewQuestion);
            exerciseType.addEventListener('change', generateNewQuestion);

            generateNewQuestion();
        });
    </script>
</body>
</html>
