<!doctype html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω ƒê·ªãa B√†n & ƒê·ªëi T∆∞·ª£ng (ƒê·∫ßy ƒë·ªß)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        body { font-family: 'Inter', sans-serif; transition: background-color .3s, color .3s }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.5); justify-content: center; align-items: center; }
        .hidden { display: none; }
        .tab-button { transition: all .2s ease-in-out; border-bottom-width: 2px; border-bottom-color: transparent; }
        .tab-button.active { color: #4f46e5; border-bottom-color: #4f46e5; font-weight: 600; }
        body.dark { background: #121212; color: #e0e0e0; }
        .dark .bg-white { background: #1e1e1e; }
        .dark .text-slate-800 { color: #e0e0e0; }
        .dark .text-slate-600 { color: #c0c0c0; }
        .dark .border-slate-200 { border-color: #333; }
        .dark .bg-slate-200 { background: #4a4a4a; }
        .dark .text-slate-700 { color: #b0b0b0; }
        .dark .bg-gray-100 { background: #2a2a2a; }
        .dark .bg-gray-800 { background: #333; }
    </style>
</head>
<body class="bg-slate-50 flex items-center justify-center min-h-screen p-4 transition-colors duration-300">
    <div class="bg-white rounded-xl shadow-2xl p-6 md:p-8 w-full max-w-5xl mx-auto transition-colors duration-300">
        <h1 class="text-4xl font-bold text-center text-slate-800 mb-2">H·ªá Th·ªëng Qu·∫£n L√Ω ƒê·ªãa B√†n & ƒê·ªëi T∆∞·ª£ng</h1>
        <p class="text-center text-slate-600 mb-6">Qu·∫£n l√Ω c√°c Th√¥n, Bu√¥n, H·ªô, Th√†nh vi√™n v√† ƒê·ªëi t∆∞·ª£ng.</p>
        <div class="flex justify-end mb-4">
            <button id="theme-toggle" class="p-2 rounded-full bg-slate-200 dark:bg-gray-700 text-slate-800 dark:text-gray-300 transition-colors duration-200">üåû/üåô</button>
        </div>
        <div class="flex border-b border-slate-200 mb-6 space-x-4">
            <button id="tab-precincts" class="tab-button py-2 px-4 text-lg text-slate-600 active">ƒê·ªãa b√†n</button>
            <button id="tab-political" class="tab-button py-2 px-4 text-lg text-slate-600">H·ªá th·ªëng ch√≠nh tr·ªã</button>
            <button id="tab-subjects" class="tab-button py-2 px-4 text-lg text-slate-600">ƒê·ªëi t∆∞·ª£ng</button>
            <button id="tab-incidents" class="tab-button py-2 px-4 text-lg text-slate-600">V·ª• vi·ªác</button>
            <button id="tab-images" class="tab-button py-2 px-4 text-lg text-slate-600">H√¨nh ·∫£nh</button>
        </div>
        <div id="tab-content">
            <!-- Precincts Section -->
            <div id="precincts-tab-content" class="tab-panel">
                <h2 class="text-2xl font-semibold mb-4">Danh s√°ch Th√¥n, Bu√¥n</h2>
                <div class="flex space-x-2 mb-4">
                    <input id="new-precinct-name" type="text" placeholder="T√™n th√¥n/bu√¥n m·ªõi" class="flex-1 border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-600 dark:text-white" />
                    <button id="add-precinct-btn" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 transition-colors">Th√™m</button>
                </div>
                <ul id="precincts-list" class="list-disc pl-6 space-y-2 text-slate-700"></ul>
            </div>
            <!-- Political System Section -->
            <div id="political-tab-content" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-4">ƒê·ªôi An ninh</h2>
                <div class="flex space-x-2 mb-4">
                    <input id="new-security-member-name" type="text" placeholder="H·ªç t√™n" class="flex-1 border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-600 dark:text-white" />
                    <input id="new-security-member-precinct" type="text" placeholder="Th√¥n/Bu√¥n" class="flex-1 border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-600 dark:text-white" />
                    <button id="add-security-member-btn" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 transition-colors">Th√™m</button>
                </div>
                <ul id="security-team-list" class="list-disc pl-6 space-y-2 text-slate-700"></ul>

                <h2 class="text-2xl font-semibold mb-4 mt-8">Danh s√°ch H·ªô gia ƒë√¨nh</h2>
                <div class="flex space-x-2 mb-4">
                    <input id="new-household-name" type="text" placeholder="T√™n ch·ªß h·ªô" class="flex-1 border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-600 dark:text-white" />
                    <input id="new-household-precinct" type="text" placeholder="Th√¥n/Bu√¥n" class="flex-1 border rounded px-2 py-1 dark:bg-gray-800 dark:border-gray-600 dark:text-white" />
                    <button id="add-household-btn" class="bg-green-600 text-white px-4 py-1 rounded hover:bg-green-700 transition-colors">Th√™m</button>
                </div>
                <ul id="households-list" class="list-disc pl-6 space-y-2 text-slate-700"></ul>
            </div>
            <!-- Other Sections -->
            <div id="subjects-tab-content" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-4">Qu·∫£n l√Ω ƒê·ªëi t∆∞·ª£ng</h2>
                <p class="text-slate-600">T√≠nh nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c b·ªï sung trong c√°c b·∫£n c·∫≠p nh·∫≠t sau.</p>
            </div>
            <div id="incidents-tab-content" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-4">Qu·∫£n l√Ω V·ª• vi·ªác</h2>
                <p class="text-slate-600">T√≠nh nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c b·ªï sung trong c√°c b·∫£n c·∫≠p nh·∫≠t sau.</p>
            </div>
            <div id="images-tab-content" class="tab-panel hidden">
                <h2 class="text-2xl font-semibold mb-4">Qu·∫£n l√Ω H√¨nh ·∫£nh</h2>
                <p class="text-slate-600">T√≠nh nƒÉng n√†y s·∫Ω ƒë∆∞·ª£c b·ªï sung trong c√°c b·∫£n c·∫≠p nh·∫≠t sau.</p>
            </div>
        </div>
    </div>
    <div id="modal" class="modal">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-lg w-full modal-content dark:bg-gray-800 dark:text-white">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-center"></h3>
            <div id="modal-content-area"></div>
        </div>
    </div>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
        
        const SUPABASE_URL = 'https://skbjeeyisyfifzoiuxeq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrYmplZXlpc3lpZml6b2l1eGVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjExNzE4NzcsImV4cCI6MTczNjc2NTg3N30.C3005p_rVdFjBfT4X1K7FqJ0w0iC5N9tqA4Mv1I0a5I';

        const TABLES = {
          precincts: 'precincts',
          households: 'households',
          securityTeam: 'security_team'
        }

        let supabase = null;
        let userId = 'anonymous_' + Date.now();
        
        function showCustomAlert(message) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content-area');
            
            modalTitle.textContent = 'Th√¥ng b√°o';
            modalContent.innerHTML = `<p class="text-center">${message}</p><div class="flex justify-center mt-4"><button id="close-modal" class="bg-blue-600 text-white px-4 py-2 rounded">ƒê√≥ng</button></div>`;
            modal.style.display = 'flex';
            
            document.getElementById('close-modal').onclick = () => {
                modal.style.display = 'none';
            };
        }
        
        function showCustomConfirm(message, onConfirm, onCancel) {
            const modal = document.getElementById('modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content-area');
            
            modalTitle.textContent = 'X√°c nh·∫≠n';
            modalContent.innerHTML = `<p class="text-center">${message}</p><div class="flex justify-center space-x-4 mt-4"><button id="confirm-yes" class="bg-green-600 text-white px-4 py-2 rounded">ƒê·ªìng √Ω</button><button id="confirm-no" class="bg-red-600 text-white px-4 py-2 rounded">H·ªßy b·ªè</button></div>`;
            modal.style.display = 'flex';
            
            document.getElementById('confirm-yes').onclick = () => {
                modal.style.display = 'none';
                if (onConfirm) onConfirm();
            };
            document.getElementById('confirm-no').onclick = () => {
                modal.style.display = 'none';
                if (onCancel) onCancel();
            };
        }

        const initialPrecincts = [
          "Th√¥n 5", "Th√¥n 6", "Th√¥n 7", "Th√¥n 8", "Th√¥n 9",
          "Bu√¥n Al√™ G≈è", "Bu√¥n Dhu", "Bu√¥n Ea Kj≈èh A", "Bu√¥n Ea Kj≈èh B", "Bu√¥n Hnƒõ",
          "Bu√¥n Kmi√™n", "Bu√¥n Pheo", "Bu√¥n S«êng A", "Bu√¥n Tung KrƒÉk", "Bu√¥n Trang",
          "Bu√¥n TrƒÉp", "Bu√¥n Tring 4", "Th√¥n ƒê√¥ng Xu√¢n", "Th√¥n Ea Kung", "Bu√¥n Klat A",
          "Bu√¥n Klat B", "Bu√¥n Klat C", "Th√¥n Quy·∫øt Th·∫Øng", "Th√¥n T√¢n H·ª£p", "Th√¥n 1A",
          "Th√¥n 1B", "Th√¥n 2A", "Th√¥n 2B", "Th√¥n 3", "Th√¥n 6", "Th√¥n 7", "Th√¥n 8"
        ];
        
        const initialHouseholds = [
          { name: "Y √ëUT NI√ä", precinct: "bu√¥n al√™ g≈è", members: 7 },
          { name: "Y BLUM NI√ä", precinct: "bu√¥n al√™ g≈è", members: 3 },
          { name: "Y BL∆†R ML√î", precinct: "bu√¥n al√™ g≈è", members: 7 },
          { name: "Y K≈¨T KRI√äNG", precinct: "bu√¥n al√™ g≈è", members: 5 },
          { name: "Y TAM KBU√îR", precinct: "bu√¥n al√™ g≈è", members: 8 },
          { name: "Y BLIAH NI√ä", precinct: "bu√¥n al√™ g≈è", members: 10 },
          { name: "Y BIƒÇI ML√î", precinct: "bu√¥n al√™ g≈è", members: 2 },
          { name: "Y SU√îM ML√î", precinct: "bu√¥n al√™ g≈è", members: 7 },
          { name: "Y KH√îN KNUL", precinct: "bu√¥n al√™ g≈è", members: 3 },
          { name: "Y DHIƒÇ NI√ä", precinct: "bu√¥n al√™ g≈è", members: 6 },
        ];
        
        const initialSecurityTeam = [
          { name: "B√πi Quang Trung", precinct: "Th√¥n 5", title: "T·ªï tr∆∞·ªüng" },
          { name: "L√™ Quang Tr∆∞·ªùng", precinct: "Th√¥n 5", title: "T·ªï ph√≥" },
          { name: "Nguy·ªÖn Ph√∫ Nh∆°n", precinct: "Th√¥n 5", title: "T·ªï vi√™n" },
          { name: "Ho√†ng Anh ƒê·ªãnh", precinct: "Th√¥n 6", title: "T·ªï tr∆∞·ªüng" },
          { name: "L√™ Trung Ki√™n", precinct: "Th√¥n 6", title: "T·ªï ph√≥" },
          { name: "Ph·∫°m C√¥ng", precinct: "Th√¥n 6", title: "T·ªï vi√™n" },
        ];

        async function initializeData() {
          supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          
          // Seed initial data for precincts
          for (const item of initialPrecincts) {
            await supabase.from(TABLES.precincts).upsert({ name: item, creator_id: userId, created_at: new Date().toISOString() }, { onConflict: 'name' });
          }
          
          // Seed initial data for households
          for (const item of initialHouseholds) {
            await supabase.from(TABLES.households).upsert({ 
                name: item.name, 
                precinct: item.precinct, 
                members: item.members,
                creator_id: userId, 
                created_at: new Date().toISOString() 
            }, { onConflict: 'name' });
          }
          
          // Seed initial data for security team
          for (const item of initialSecurityTeam) {
            await supabase.from(TABLES.securityTeam).upsert({ 
                name: item.name, 
                precinct: item.precinct, 
                title: item.title,
                creator_id: userId, 
                created_at: new Date().toISOString() 
            }, { onConflict: 'name' });
          }

          setupRealtime();
          fetchPrecincts();
        }

        function setupRealtime() {
          const precinctChannel = supabase.channel('precinct-changes');
          precinctChannel.on('postgres_changes', { event: '*', schema: 'public', table: TABLES.precincts }, () => fetchPrecincts()).subscribe();
          
          const householdChannel = supabase.channel('household-changes');
          householdChannel.on('postgres_changes', { event: '*', schema: 'public', table: TABLES.households }, () => fetchHouseholds()).subscribe();

          const securityChannel = supabase.channel('security-changes');
          securityChannel.on('postgres_changes', { event: '*', schema: 'public', table: TABLES.securityTeam }, () => fetchSecurityTeam()).subscribe();
        }

        // Precincts functions
        async function fetchPrecincts() {
          const { data, error } = await supabase.from(TABLES.precincts).select('*').order('name');
          const list = document.getElementById('precincts-list');
          list.innerHTML = '';
          if (data) {
            data.forEach(item => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg mb-2';
              li.innerHTML = `<span class="text-base">${item.name}</span><button class="delete-btn text-red-600 dark:text-red-400 text-sm p-1 rounded hover:bg-red-100 dark:hover:bg-red-900 transition-colors" data-id="${item.id}" data-table="${TABLES.precincts}">X√≥a</button>`;
              list.appendChild(li);
            });
          } else if (error) {
            console.error('Error fetching precincts:', error);
            showCustomAlert('L·ªói khi l·∫•y d·ªØ li·ªáu ƒë·ªãa b√†n.');
          }
          attachDeleteListeners();
        }

        async function addPrecinct(name) {
          if (!name) return;
          const { error } = await supabase.from(TABLES.precincts).insert({ name, creator_id: userId, created_at: new Date().toISOString() });
          if (error) {
            console.error('Error adding precinct:', error);
            showCustomAlert('Kh√¥ng th·ªÉ th√™m ƒë·ªãa b√†n. T√™n c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i.');
          }
        }

        // Households functions
        async function fetchHouseholds() {
          const { data, error } = await supabase.from(TABLES.households).select('*').order('name');
          const list = document.getElementById('households-list');
          list.innerHTML = '';
          if (data) {
            data.forEach(item => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg mb-2';
              li.innerHTML = `<span class="text-base">${item.name} (${item.precinct})</span><button class="delete-btn text-red-600 dark:text-red-400 text-sm p-1 rounded hover:bg-red-100 dark:hover:bg-red-900 transition-colors" data-id="${item.id}" data-table="${TABLES.households}">X√≥a</button>`;
              list.appendChild(li);
            });
          } else if (error) {
            console.error('Error fetching households:', error);
            showCustomAlert('L·ªói khi l·∫•y d·ªØ li·ªáu h·ªô gia ƒë√¨nh.');
          }
          attachDeleteListeners();
        }

        async function addHousehold(name, precinct) {
          if (!name || !precinct) return;
          const { error } = await supabase.from(TABLES.households).insert({ name, precinct, creator_id: userId, created_at: new Date().toISOString() });
          if (error) {
            console.error('Error adding household:', error);
            showCustomAlert('Kh√¥ng th·ªÉ th√™m h·ªô gia ƒë√¨nh. T√™n c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i.');
          }
        }
        
        // Security Team functions
        async function fetchSecurityTeam() {
          const { data, error } = await supabase.from(TABLES.securityTeam).select('*').order('name');
          const list = document.getElementById('security-team-list');
          list.innerHTML = '';
          if (data) {
            data.forEach(item => {
              const li = document.createElement('li');
              li.className = 'flex justify-between items-center bg-gray-100 dark:bg-gray-700 p-2 rounded-lg mb-2';
              li.innerHTML = `<span class="text-base">${item.name} (${item.title} - ${item.precinct})</span><button class="delete-btn text-red-600 dark:text-red-400 text-sm p-1 rounded hover:bg-red-100 dark:hover:bg-red-900 transition-colors" data-id="${item.id}" data-table="${TABLES.securityTeam}">X√≥a</button>`;
              list.appendChild(li);
            });
          } else if (error) {
            console.error('Error fetching security team:', error);
            showCustomAlert('L·ªói khi l·∫•y d·ªØ li·ªáu ƒë·ªôi an ninh.');
          }
          attachDeleteListeners();
        }

        async function addSecurityTeamMember(name, precinct) {
          if (!name || !precinct) return;
          const { error } = await supabase.from(TABLES.securityTeam).insert({ name, precinct, creator_id: userId, created_at: new Date().toISOString() });
          if (error) {
            console.error('Error adding security member:', error);
            showCustomAlert('Kh√¥ng th·ªÉ th√™m th√†nh vi√™n. T√™n c√≥ th·ªÉ ƒë√£ t·ªìn t·∫°i.');
          }
        }

        // Universal delete function
        async function deleteItem(id, table) {
          const { error } = await supabase.from(table).delete().eq('id', id);
          if (error) {
            console.error(`Error deleting from ${table}:`, error);
            showCustomAlert('Kh√¥ng th·ªÉ x√≥a m·ª•c n√†y.');
          }
        }

        function attachDeleteListeners() {
          document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              const id = btn.getAttribute('data-id');
              const table = btn.getAttribute('data-table');
              showCustomConfirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y?', () => {
                deleteItem(id, table);
              });
            });
          });
        }

        function setupTabSwitching() {
          const tabButtons = document.querySelectorAll('.tab-button');
          const tabPanels = document.querySelectorAll('.tab-panel');

          tabButtons.forEach(button => {
            button.addEventListener('click', () => {
              tabButtons.forEach(btn => btn.classList.remove('active'));
              tabPanels.forEach(panel => panel.classList.add('hidden'));
              button.classList.add('active');
              const targetPanelId = button.id.replace('tab-', '') + '-tab-content';
              document.getElementById(targetPanelId).classList.remove('hidden');

              // Fetch data for the selected tab
              if (button.id === 'tab-precincts') {
                fetchPrecincts();
              } else if (button.id === 'tab-political') {
                fetchHouseholds();
                fetchSecurityTeam();
              }
            });
          });
        }

        // Add event listeners for new buttons
        document.getElementById('add-precinct-btn').addEventListener('click', () => {
          const nameInput = document.getElementById('new-precinct-name');
          const name = nameInput.value.trim();
          if (name) {
            addPrecinct(name);
            nameInput.value = '';
          }
        });
        
        document.getElementById('add-security-member-btn').addEventListener('click', () => {
            const nameInput = document.getElementById('new-security-member-name');
            const precinctInput = document.getElementById('new-security-member-precinct');
            const name = nameInput.value.trim();
            const precinct = precinctInput.value.trim();
            if (name && precinct) {
                addSecurityTeamMember(name, precinct);
                nameInput.value = '';
                precinctInput.value = '';
            }
        });
        
        document.getElementById('add-household-btn').addEventListener('click', () => {
            const nameInput = document.getElementById('new-household-name');
            const precinctInput = document.getElementById('new-household-precinct');
            const name = nameInput.value.trim();
            const precinct = precinctInput.value.trim();
            if (name && precinct) {
                addHousehold(name, precinct);
                nameInput.value = '';
                precinctInput.value = '';
            }
        });

        document.getElementById('theme-toggle').addEventListener('click', () => {
            document.body.classList.toggle('dark');
        });

        initializeData();
        setupTabSwitching();
    </script>
</body>
</html>
